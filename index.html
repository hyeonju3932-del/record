<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ì¬ë¯¼ì´ì™€ ë°œìŒ ë¹„êµí•˜ê¸°</title>
<style>
  body {
    font-family: "Pretendard", sans-serif;
    background: #fff7d1;
    margin: 0; padding: 0;
    display: flex; flex-direction: column;
    align-items: center;
    padding: 20px;
    text-align: center;
  }
  
  /* --- 1. ì œëª© ë°•ìŠ¤ ìŠ¤íƒ€ì¼ --- */
  h1 {
    font-size: 22px;
    font-weight: 700;
    margin-bottom: 5px; /* ì†Œì œëª©ê³¼ì˜ ê°„ê²©ì„ ìœ„í•´ ì¤„ì„ */
    background-color: #ffffff;
    padding: 15px 30px;
    border-radius: 20px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    display: inline-block;
    color: #333;
  }

  /* ì†Œì œëª© ìŠ¤íƒ€ì¼ */
  .subtitle {
    font-size: 16px;
    color: #795548; /* ë¶€ë“œëŸ¬ìš´ ê°ˆìƒ‰ í†¤ */
    font-weight: 600;
    margin-top: 0;
    margin-bottom: 25px;
  }

  /* --- 2. ìºë¦­í„°ì™€ ë§í’ì„  ë ˆì´ì•„ì›ƒ --- */
  .character-area {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-bottom: 30px;
    gap: 15px;
  }

  .speech-bubble {
    background: #ffffff;
    padding: 15px 20px;
    border-radius: 15px;
    position: relative;
    max-width: 200px;
    text-align: left;
    font-size: 15px;
    line-height: 1.4;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    color: #555;
    font-weight: 600; /* ê¸€ì”¨ ì¡°ê¸ˆ ë” ì§„í•˜ê²Œ */
  }

  .speech-bubble::after {
    content: '';
    position: absolute;
    left: -10px;
    top: 50%;
    transform: translateY(-50%);
    border-style: solid;
    border-width: 10px 10px 10px 0;
    border-color: transparent #ffffff transparent transparent;
  }

  .section {
    background: #ffffff;
    width: 100%; max-width: 420px;
    border-radius: 20px;
    padding: 20px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    margin-bottom: 25px;
  }
  
  h2 { font-size: 20px; margin-top: 0; }

  .btn {
    border: none; padding: 12px 20px; border-radius: 12px;
    font-size: 16px; cursor: pointer; display: inline-block; margin: 5px;
    font-weight: 600; color: #333; transition: 0.2s;
  }
  .btn-rec { background: #ff8a80; color: white; }
  .btn-rec.recording { background: #d32f2f; animation: pulse 1.5s infinite; }
  
  @keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
  }

  .result-box {
    margin-top: 15px; background: #fff3c4; padding: 15px;
    border-radius: 14px; text-align: center; font-size: 18px; font-weight: 600;
    min-height: 50px; display: flex; flex-direction: column; justify-content: center; align-items: center;
  }
  .recognized-text { font-size: 14px; color: #666; font-weight: 400; margin-top: 5px; }
  select { padding: 8px; font-size: 16px; border-radius: 8px; margin-bottom: 15px; width: 100%; }
  audio { width: 100%; margin-bottom: 10px; }
</style>
</head>
<body>

<h1>1. ì•„, ì–´, ì˜¤, ìš°, ìœ¼, ì´</h1>
<p class="subtitle">ì‹¤ë ¥ì„ í‚¤ì›Œë³´ì âœ¨</p>

<div class="character-area">
  <img src="robot-character.jpg" alt="ì¬ë¯¼" width="120" onerror="this.src='https://via.placeholder.com/120?text=Robot'" style="border-radius: 10px;" />
  
  <div class="speech-bubble">
    ë„¤ê°€ ë§í•œ ì†Œë¦¬ê°€ ë§ëŠ”ì§€ ë“¤ì–´ë³´ê³  ì•Œë ¤ì¤„ê²Œ!
  </div>
</div>

<div class="section">
  <h2>ì†Œë¦¬ ë¹„êµí•˜ê¸°</h2>
  <p>1. ë¬¸ì¥ì„ ê³ ë¥´ê³  ì†Œë¦¬ë¥¼ ë“¤ì–´ë´.</p> <select id="sentenceSelect" onchange="setSentence()">
    <option value="">ë¬¸ì¥ ì„ íƒ</option>
    <option value="ì•„ë¹ ê°€ ìš°ì‚°ì„ ì¨ìš”">1. ì•„ë¹ ê°€ ìš°ì‚°ì„ ì¨ìš”.</option>
    <option value="ì•„ê¸°ê°€ ìš°ìœ ë¥¼ ë¨¹ì–´ìš”">2. ì•„ê¸°ê°€ ìš°ìœ ë¥¼ ë¨¹ì–´ìš”.</option>
    <option value="ì–´ë¨¸ë‹ˆê°€ ì•„ì´ì™€ ë†€ì•„ìš”">3. ì–´ë¨¸ë‹ˆê°€ ì•„ì´ì™€ ë†€ì•„ìš”.</option>
    <option value="ì˜¤ë¹ ê°€ ì•„ì´ìŠ¤í¬ë¦¼ì„ ì‚¬ìš”">4. ì˜¤ë¹ ê°€ ì•„ì´ìŠ¤í¬ë¦¼ì„ ì‚¬ìš”.</option>
  </select>

  <audio id="baseAudioPlayer" controls></audio>
  
  <hr style="margin: 20px 0; border: 0; border-top: 1px dashed #ccc;">

  <p>2. ì•„ë˜ ë²„íŠ¼ì„ ëˆ„ë¥´ê³  ë”°ë¼ ì½ì–´ë´.</p> <button id="recBtn" class="btn btn-rec" onclick="toggleRecording()">ğŸ¤ ë…¹ìŒ ì‹œì‘</button>
  
  <div id="result" class="result-box">
    <span>ê²°ê³¼ë¥¼ ë³´ì—¬ì¤„ê²Œ.</span> </div>
</div>

<script>
let recognition;
let isRecording = false;
let targetText = "";

// íŒŒì¼ëª…ì€ ê·¸ëŒ€ë¡œ ìœ ì§€
const audioFiles = {
  "ì•„ë¹ ê°€ ìš°ì‚°ì„ ì¨ìš”": "base_sentence_1.mp3",
  "ì•„ê¸°ê°€ ìš°ìœ ë¥¼ ë¨¹ì–´ìš”": "base_sentence_2.mp3",
  "ì–´ë¨¸ë‹ˆê°€ ì•„ì´ì™€ ë†€ì•„ìš”": "base_sentence_3.mp3",
  "ì˜¤ë¹ ê°€ ì•„ì´ìŠ¤í¬ë¦¼ì„ ì‚¬ìš”": "base_sentence_4.mp3"
};

if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SpeechRecognition();
  recognition.lang = 'ko-KR';
  recognition.continuous = false;
  recognition.interimResults = false;

  recognition.onresult = function(event) {
    const spokenText = event.results[0][0].transcript;
    compareResult(spokenText);
    stopRecordingUI();
  };

  recognition.onerror = function(event) {
    console.error(event.error);
    stopRecordingUI();
    // ë°˜ë§ ìˆ˜ì •
    document.getElementById('result').innerHTML = "ğŸ˜• ì†Œë¦¬ê°€ ì˜ ì•ˆ ë“¤ë ¤. ë‹¤ì‹œ í•´ë³¼ê¹Œ?";
  };
} else {
  // ë°˜ë§ ìˆ˜ì •
  alert("ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ì•ˆ ë¼. í¬ë¡¬ì„ ì¨ì¤˜!");
}

function setSentence() {
  const select = document.getElementById('sentenceSelect');
  targetText = select.value;
  
  if (targetText && audioFiles[targetText]) {
    document.getElementById('baseAudioPlayer').src = audioFiles[targetText];
    // ë°˜ë§ ìˆ˜ì •
    document.getElementById('result').innerHTML = "ì¤€ë¹„ ì™„ë£Œ! ë…¹ìŒ ë²„íŠ¼ì„ ëˆŒëŸ¬ì¤˜.";
  } else {
    document.getElementById('baseAudioPlayer').src = "";
    targetText = "";
  }
}

function toggleRecording() {
  if (!targetText) {
    // ë°˜ë§ ìˆ˜ì •
    alert("ë¨¼ì € ë¬¸ì¥ì„ ê³¨ë¼ì¤˜!");
    return;
  }

  if (!isRecording) {
    isRecording = true;
    recognition.start();
    const btn = document.getElementById('recBtn');
    // ë°˜ë§ ìˆ˜ì •
    btn.innerHTML = "ğŸ‘‚ ë“£ê³  ìˆì–´...";
    btn.classList.add('recording');
    document.getElementById('result').innerHTML = "ë§í•´ ë´...";
  } else {
    recognition.stop();
    stopRecordingUI();
  }
}

function stopRecordingUI() {
  isRecording = false;
  const btn = document.getElementById('recBtn');
  btn.innerHTML = "ğŸ¤ ë…¹ìŒ ì‹œì‘";
  btn.classList.remove('recording');
}

function compareResult(spokenText) {
  const cleanTarget = targetText.replace(/\s+/g, '');
  const cleanSpoken = spokenText.replace(/\s+/g, '');
  const similarity = getSimilarity(cleanTarget, cleanSpoken);

  let emoji = '';
  let message = '';

  // ë°˜ë§ ìˆ˜ì •
  if (similarity === 100) {
    emoji = 'ğŸ¥³';
    message = 'ì •í™•í•´! (100ì )';
  } else if (similarity >= 70) {
    emoji = 'ğŸ™‚';
    message = 'ë¹„ìŠ·í•´! ì¡°ê¸ˆ ë” ë˜ë°•ë˜ë°• ë§í•´ë³¼ê¹Œ?';
  } else {
    emoji = 'ğŸ˜•';
    message = 'ë‹¬ë¼. ë‹¤ì‹œ í•œë²ˆ ë“¤ì–´ë´.';
  }

  document.getElementById('result').innerHTML = `
    <div>${emoji} ${message}</div>
    <div class="recognized-text">ë‚´ê°€ í•œ ë§: "${spokenText}"</div>
  `;
}

function getSimilarity(s1, s2) {
  const longer = s1.length > s2.length ? s1 : s2;
  const shorter = s1.length > s2.length ? s2 : s1;
  const longerLength = longer.length;
  if (longerLength === 0) return 1.0;
  const editDistance = levenshtein(longer, shorter);
  return ((longerLength - editDistance) / longerLength) * 100;
}

function levenshtein(s, t) {
  if (!s.length) return t.length;
  if (!t.length) return s.length;
  const arr = [];
  for (let i = 0; i <= t.length; i++) {
    arr[i] = [i];
    for (let j = 1; j <= s.length; j++) {
      arr[i][j] =
        i === 0
          ? j
          : Math.min(
              arr[i - 1][j] + 1,
              arr[i][j - 1] + 1,
              arr[i - 1][j - 1] + (s[j - 1] === t[i - 1] ? 0 : 1)
            );
    }
  }
  return arr[t.length][s.length];
}
</script>
</body>
</html>